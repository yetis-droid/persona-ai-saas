// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String?
  googleId     String?   @unique
  name         String?
  role         String    @default("user")  // "user" or "admin"
  
  // なりすまし防止システム
  isEmailVerified    Boolean   @default(false)  // メール認証済みか
  emailVerificationToken String?  // メール認証トークン
  emailVerifiedAt    DateTime? // 認証完了日時
  isOfficialAccount  Boolean   @default(false)  // 公式アカウント（管理者のみ付与可能）
  officialBadge      String?   // 公式バッジの種類（"creator", "partner", "verified"）
  verificationLevel  Int       @default(0)  // 認証レベル 0=未認証, 1=メール認証, 2=本人確認, 3=公式
  
  // サブスクリプション情報
  subscriptionTier    String    @default("free")  // "free" or "premium"
  stripeCustomerId    String?   @unique
  stripeSubscriptionId String?  @unique
  subscriptionStatus  String    @default("inactive") // "active", "inactive", "canceled"
  subscriptionEndsAt  DateTime?
  
  // 使用量制限
  dailyConversationCount Int     @default(0)
  lastConversationDate   DateTime?
  
  // チケットシステム（前払い・リスクゼロ）
  ticketBalance          Int      @default(0)  // 残りチケット数
  ticketPurchaseHistory  Json     @default("[]")  // 購入履歴 [{date, tickets, amount, sessionId}]
  ticketLastPurchaseAt   DateTime?  // 最終購入日時
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  personas     Persona[]
  usageLogs    UsageLog[]
}

model Persona {
  id                     String         @id @default(cuid())
  userId                 String
  user                   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 基本情報
  genre                  String
  oneLiner               String
  creatorCallname        String
  fanCallname            String
  
  // 話し方
  tone                   String
  politenessLevel        Int
  emojiUsage             String
  replyLength            String
  phrasingExamples       String         @db.Text
  bannedPhrases          String         @db.Text
  
  // 距離感/境界線
  relationshipStyle      String
  smalltalkLevel         String
  supportScope           String
  refusalStyle           String
  boundaries             String         @db.Text
  
  // 世界観/価値観
  worldKeywords          String         @db.Text
  coreValues             String         @db.Text
  consistencyRule        String
  
  // FAQ
  faqPairs               String         @db.Text
  
  // 追加NG
  ngTopicsExtra          String         @db.Text
  
  // 共有情報
  shareLinks             String         @db.Text
  shareInfo              String         @db.Text
  
  // 生成されたプロンプト
  systemPrompt           String         @db.Text
  
  // LINE連携
  lineChannelAccessToken String?
  lineChannelSecret      String?
  
  isActive               Boolean        @default(false)
  
  // なりすまし防止
  isVerified             Boolean        @default(false)  // 認証済み人格（本物）
  verifiedBy             String?        // 認証した管理者のID
  verifiedAt             DateTime?      // 認証日時
  reportCount            Int            @default(0)  // 通報回数
  isSuspended            Boolean        @default(false)  // 停止中
  suspendedReason        String?        @db.Text
  
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  
  conversations          Conversation[]
}

model Conversation {
  id           String   @id @default(cuid())
  personaId    String
  persona      Persona  @relation(fields: [personaId], references: [id], onDelete: Cascade)
  source       String   // "web" or "line"
  fanLineId    String?
  userMessage  String   @db.Text
  aiReply      String   @db.Text
  rating       Int?     // 1-5
  isNgDetected Boolean  @default(false)
  createdAt    DateTime @default(now())
  
  @@index([personaId, createdAt])
}

// 使用量ログ
model UsageLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String   // "conversation", "persona_create", etc.
  metadata  String?  @db.Text
  createdAt DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([userId, action, createdAt])
}
